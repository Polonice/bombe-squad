<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Star Wars : Console Synchro</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        :root { --hologram: #00d2ff; --sith-red: #ff0000; --empire-orange: #ff9d00; }
        
        body { 
            background: #050507 url('https://i.pinimg.com/564x/2a/c3/15/2ac315e496a35eb3ad0cd5867de78789.jpg') no-repeat center center fixed; 
            background-size: cover;
            color: var(--hologram); font-family: 'Orbitron', sans-serif;
            display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0;
        }

        .master-bar { background: rgba(255, 157, 0, 0.2); padding: 10px; border: 1px solid var(--empire-orange); margin-bottom: 20px; border-radius: 5px; z-index: 100; }
        
        .game-wrapper { display: flex; gap: 20px; background: rgba(0,0,0,0.7); padding: 30px; border-radius: 15px; border: 1px solid var(--hologram); }
        
        .wires-sidebar { display: flex; flex-direction: column; gap: 10px; width: 120px; }
        .wire { height: 50px; border: 1px solid #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; color: #fff; transition: 0.2s; }
        .wire.cut { opacity: 0.1; pointer-events: none; }

        .bomb-container { width: 300px; text-align: center; }
        #timer { font-size: 3.5rem; color: var(--sith-red); text-shadow: 0 0 15px var(--sith-red); margin-bottom: 10px; }
        #display { background: #000; border: 1px solid var(--hologram); height: 50px; font-size: 2rem; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; }
        
        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        button { background: #222; border: 1px solid #444; color: var(--empire-orange); padding: 10px; cursor: pointer; font-family: 'Orbitron'; }
        button:hover { background: #333; }

        #msg-popup { position: fixed; top: 20px; background: var(--hologram); color: #000; padding: 10px 20px; font-weight: bold; border-radius: 5px; display: none; }
    </style>
</head>
<body>

    <div class="master-bar" id="role-panel">
        CHOISIR RÔLE : 
        <button onclick="chooseRole('master')">DEVENIR MAÎTRE</button>
        <button onclick="chooseRole('viewer')">SPECTATEUR</button>
    </div>

    <div id="msg-popup"></div>

    <div class="game-wrapper">
        <div class="wires-sidebar">
            <div class="wire" id="w0" style="background:#900" onclick="handleWire(0)">FIL-A</div>
            <div class="wire" id="w1" style="background:#009" onclick="handleWire(1)">FIL-B</div>
            <div class="wire" id="w2" style="background:#090" onclick="handleWire(2)">FIL-C</div>
            <div class="wire" id="w3" style="background:#990; color:#000" onclick="handleWire(3)">FIL-D</div>
        </div>

        <div class="bomb-container">
            <div id="timer">03:00</div>
            <div id="display">----</div>
            <div class="keypad" id="keypad">
                <button onclick="handlePress(1)">1</button><button onclick="handlePress(2)">2</button><button onclick="handlePress(3)">3</button>
                <button onclick="handlePress(4)">4</button><button onclick="handlePress(5)">5</button><button onclick="handlePress(6)">6</button>
                <button onclick="handlePress(7)">7</button><button onclick="handlePress(8)">8</button><button onclick="handlePress(9)">9</button>
                <button onclick="handleReset()" style="color:#666">CLR</button>
                <button onclick="handlePress(0)">0</button>
                <button onclick="handleCheck()" style="color:var(--hologram)">OK</button>
            </div>
        </div>
    </div>

<script>
    // --- CONFIGURATION FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyBuZ3BwcqvxPTP8hzMv_BTTz871vGp8uz0", // <--- REMPLACE ICI
        databaseURL: "https://star-wars-bombe-default-rtdb.europe-west1.firebasedatabase.app/",
        projectId: "star-wars-bombe",
        appId: "star-wars-bombe" // <--- REMPLACE ICI
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const gameRef = db.ref("gameState");

    let role = 'viewer';
    let localInput = "";
    let secretCode = ""; 
    let gameActive = true;
    
    // Définition des actions des fils (identique au local)
    let wireActions = [
        { type: "bonus", msg: "ÉNERGIE RÉCUPÉRÉE : +30s" },
        { type: "boom", msg: "SÉCURITÉ DÉCLENCHÉE : EXPLOSION !" },
        { type: "win", msg: "SYSTÈME COURT-CIRCUITÉ : RÉUSSITE !" },
        { type: "nothing", msg: "CIRCUIT MORT : AUCUN EFFET" }
    ];

    // --- AUDIO ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function beep(freq, dur, type="square") {
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.type = type; osc.frequency.value = freq;
        g.gain.setValueAtTime(0.05, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);
        osc.connect(g); g.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + dur);
    }

    // --- CHOIX DU RÔLE ---
    function chooseRole(r) {
        role = r;
        document.getElementById('role-panel').style.display = 'none';
        if(role === 'master') {
            secretCode = Math.floor(1000 + Math.random() * 9000).toString();
            console.log("LE CODE SECRET EST : " + secretCode);
            
            // Mélange des fils au démarrage
            wireActions.sort(() => Math.random() - 0.5);

            gameRef.set({
                timeLeft: 180,
                display: "----",
                wires: [false, false, false, false],
                wireTypes: wireActions, // On stocke les types de fils sur le serveur
                status: "ACTIF",
                msg: "SYSTÈME PRÊT",
                isGameOver: false,
                win: false,
                shake: false
            });
            startMasterTimer();
        } else {
            document.querySelectorAll('button, .wire').forEach(el => el.style.pointerEvents = 'none');
            showPopup("MODE SPECTATEUR ACTIF");
        }
    }

    // --- LOGIQUE MAÎTRE ---
    function startMasterTimer() {
        let t = 180;
        const timerInt = setInterval(() => {
            if(!gameActive) { clearInterval(timerInt); return; }
            if(t > 0) {
                t--;
                let updates = { timeLeft: t };
                if(t <= 15) updates.shake = true;
                gameRef.update(updates);
            } else {
                gameRef.update({ isGameOver: true, win: false, msg: "TEMPS ÉCOULÉ : BOOM" });
                clearInterval(timerInt);
            }
        }, 1000);
    }

    function handlePress(n) {
        if(role !== 'master' || localInput.length >= 4) return;
        localInput += n;
        gameRef.update({ display: localInput });
        beep(600, 0.05);
    }

    function handleReset() {
        if(role !== 'master') return;
        localInput = "";
        gameRef.update({ display: "----" });
    }

    function handleCheck() {
        if(role !== 'master') return;
        if(localInput === secretCode) {
            gameRef.update({ isGameOver: true, win: true, msg: "CODE CORRECT : DÉSAMORCÉ" });
        } else {
            beep(100, 0.5, "sawtooth");
            gameRef.update({ msg: "ACCÈS REFUSÉ !" });
            handleReset();
        }
    }

    function handleWire(id) {
        if(role !== 'master' || !gameActive) return;
        
        // On récupère le type de fil depuis la base de données
        gameRef.child('wireTypes').child(id).once('value', (snapshot) => {
            const action = snapshot.val();
            gameRef.child('wires').child(id).set(true);
            
            if(action.type === "bonus") {
                gameRef.once('value', (s) => {
                    let newTime = s.val().timeLeft + 30;
                    gameRef.update({ timeLeft: newTime, msg: action.msg });
                });
            } else if(action.type === "boom") {
                gameRef.update({ isGameOver: true, win: false, msg: action.msg });
            } else if(action.type === "win") {
                gameRef.update({ isGameOver: true, win: true, msg: action.msg });
            } else {
                gameRef.update({ msg: action.msg });
            }
        });
    }

    // --- LOGIQUE COMMUNE (LECTURE) ---
    gameRef.on("value", (snapshot) => {
        const data = snapshot.val();
        if(!data) return;

        // Sync Visuelle
        const m = Math.floor(data.timeLeft / 60);
        const s = data.timeLeft % 60;
        document.getElementById('timer').innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        document.getElementById('display').innerText = data.display;

        // Sons et Vibrations
        if(data.timeLeft < 180 && !data.isGameOver) beep(200, 0.02, "sine");
        if(data.shake) document.getElementById('bomb').classList.add('shaking');

        // Fils
        data.wires.forEach((isCut, index) => {
            if(isCut) {
                const w = document.getElementById('w' + index);
                if(!w.classList.contains('cut')) {
                    w.classList.add('cut');
                    beep(1000, 0.1, "triangle");
                }
            }
        });

        // Messages et Fin
        if(data.msg) showPopup(data.msg);
        
        if(data.isGameOver) {
            gameActive = false;
            document.getElementById('timer').style.color = data.win ? "#0f0" : "#f00";
            if(!data.win) {
                document.body.style.background = "#300";
                beep(50, 1, "sawtooth");
            } else {
                beep(800, 0.5, "sine");
            }
        }
    });

    function showPopup(txt) {
        const p = document.getElementById('msg-popup');
        p.innerText = txt; p.style.display = 'block';
        setTimeout(() => p.style.display = 'none', 3000);
    }
</script>